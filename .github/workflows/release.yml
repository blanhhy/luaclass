name: Create Release

# 每当有新的版本tag推送时触发自动打包release

on:
  push:
    tags:
      - 'v*'  # 当推送v开头的tag时触发
  workflow_dispatch:  # 允许手动触发

permissions:
  contents: write
  packages: write

# 需要打包的内容：
# 1. luaclass/ 文件夹下的所有内容
# 2. .fa/ 文件夹下的所有内容
# 3. README.md 文件

# 当前的tag作为release的名字以及tag

# 从 changelog.md 中获取当前版本标题(如### v1.8)到上一个版本标题(如### v1.7)的内容，作为release的body
# 结果不包括标题本身，并且文件中只有 “### ...” 这样的标题

# 打包后的文件名为：luaclass-版本号(也就是当前标签)-FA2-universal.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Prepare release notes and create zip
        id: prepare_release
        shell: bash
        run: |
          set -euo pipefail

          # Obtain tag version (e.g. v1.2.3)
          version="${GITHUB_REF#refs/tags/}"
          echo "Preparing release for version: $version"

          # 提取 changelog.md 中的内容作为 release body
          release_body_file="release_body.txt"
          awk -v ver="$version" '
            BEGIN{found=0}
            $0 ~ "^###[[:space:]]*"ver"$" {found=1; next}
            found && $0 ~ "^###[[:space:]]*v" {exit}
            found{print}
          ' changelog.md > "$release_body_file" || true

          # Build package in a temporary dir to avoid missing-file failures
          tmpdir="package_tmp"
          rm -rf "$tmpdir"
          mkdir -p "$tmpdir"

          # 复制必要的文件到临时目录
          src_dir="luaclass"  # 源文件目录
          fa_config_dir=".fa"  # FA模块配置文件目录

          if [ -d "$src_dir" ]; then
            cp -r "$src_dir"/* "$tmpdir/" || true
          fi
          if [ -d "$fa_config_dir" ]; then
            cp -r "$fa_config_dir"/* "$tmpdir/" || true
          fi
          if [ -f README.md ]; then
            cp README.md "$tmpdir/" || true
          fi

          zip_name="luaclass-${version}-FA2-universal.zip"
          (cd "$tmpdir" && zip -r ../"$zip_name" .) >/dev/null
          rm -rf "$tmpdir"

          # Expose outputs
          echo "zip_name=$zip_name" >> "$GITHUB_OUTPUT"
          echo "release_body<<EOF" >> "$GITHUB_OUTPUT"
          cat "$release_body_file" || true
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: ${{ steps.prepare_release.outputs.release_body }}
          draft: false
          prerelease: false

      - name: Upload release asset (zip)
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.prepare_release.outputs.zip_name }}
          asset_name: ${{ steps.prepare_release.outputs.zip_name }}
          asset_content_type: application/zip
